---
// src/components/BranchesGrid.astro
export interface Branch {
  city: string;
  title?: string;
  address?: string;
  phone?: string;
}

const { branches = [] } = Astro.props as { branches: Branch[] };

// import all images from src/assets/sucursales (eager, as url)
const images = import.meta.glob('../assets/sucursales/*.{webp,png,jpg,jpeg,svg}', { eager: true, as: 'url' }) as Record<string, string>;

/** Normaliza texto: quita acentos, caracteres extra y trim */
function normalizeName(s = '') {
  return s
    .toString()
    .trim()
    .normalize('NFD')                    // separa diacríticos
    .replace(/[\u0300-\u036f]/g, '')     // quita diacríticos
    .replace(/[^a-zA-Z0-9\s-_]/g, '')    // deja solo alfanum, espacios, - y _
    .replace(/\s+/g, ' ')                // normaliza espacios
    .toUpperCase();
}

/** Crea mapa filename(normalizado) => url */
const imageMap = Object.keys(images).reduce<Record<string, string>>((acc, path) => {
  const file = path.split('/').pop() || '';
  const name = file.split('.').slice(0, -1).join('.') || file; // nombre sin extensión
  const key = normalizeName(name);
  acc[key] = images[path];
  return acc;
}, {});

/** Busca la mejor coincidencia para una ciudad */
function findImageForCity(city?: string) {
  if (!city) return null;
  const base = normalizeName(city);
  const variants = [
    base,
    base.replace(/\s+/g, ''),   // sin espacios
    base.replace(/\s+/g, '_'),  // underscore
    base.replace(/\s+/g, '-'),  // guion
  ];
  for (const v of variants) {
    if (imageMap[v]) return imageMap[v];
  }
  return null;
}

function cleanPhone(t?: string) {
  if (!t) return '';
  return t.replace(/[^\d+]/g, '');
}

function initialsFromCity(city = '') {
  return city
    .split(/\s+/)
    .map((w) => w[0] ?? '')
    .filter(Boolean)
    .slice(0, 2)
    .join('')
    .toUpperCase();
}
---
<section class="py-12">
  <div class="max-w-7xl mx-auto px-2">
    <h2 class="mb-8 text-2xl md:text-4xl font-black tracking-tight text-center text-zinc-950">
      Nuestras sucursales
    </h2>

    <div
      class="
        grid 
        grid-cols-1
        md:grid-cols-2
        gap-6
        items-start
      "
    >
      {branches.map((b) => {
        const img = findImageForCity(b.city);
        return (
          <article class="w-full max-w-[720px] bg-zinc-100 px-2 md:px-4 pb-4 md:pb-6 pt-2 md:pt-4 rounded-2xl border-2 border-white hover:border-zinc-200 hover:bg-zinc-50 transition">
            {/* Imagen o placeholder */}
            {img ? (
              <img src={img} alt={`${b.city} - sucursal`} class="w-full h-40 md:h-70 object-cover rounded-lg mb-4" />
            ) : (
              <div class="w-full h-40 md:h-70 rounded-lg bg-zinc-200 mb-4 flex items-center justify-center text-zinc-600 font-bold text-2xl">
                {initialsFromCity(b.city)}
              </div>
            )}

            <h3 class="text-xl md:text-2xl font-black text-zinc-950">{b.city}</h3>

            {b.title && <p class="text-zinc-700 font-semibold mt-1">{b.title}</p>}

            {b.address && <p class="text-zinc-600 mt-2 leading-relaxed">{b.address}</p>}

            {b.phone && (
              <p class="mt-3">
                <a class="font-semibold" href={`tel:${cleanPhone(b.phone)}`}>{b.phone}</a>
              </p>
            )}
          </article>
        );
      })}
    </div>
  </div>
</section>
